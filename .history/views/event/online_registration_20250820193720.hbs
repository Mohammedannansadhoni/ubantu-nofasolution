<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Web Page Editor</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      padding: 10px;
      gap: 10px;
      background: #fff;
      border-bottom: 1px solid #ccc;
      z-index: 2000;
      position: relative;
    }

    .toolbar select,
    .toolbar input[type="file"],
    .toolbar button {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      background: #fff;
    }

    .page-wrapper {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 50px);
      margin: 0;
    }

    header, footer {
      background: #fff;
      flex-shrink: 0;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 20px;
    }

    header {
      height: 15%;
    }

    header img {
      max-height: 80%;
      max-width: 90%;
      object-fit: contain;
    }

    footer {
      height: 15%;
      font-size: 1rem;
      font-weight: 500;
      color: #333;
    }

    .canvas-container {
      flex: 1;
      padding: 20px;
      background-color: #fff;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      overflow-y: auto;
      transition: all 0.3s ease;
    }

    .canvas-content {
      padding: 20px;
      color: #000;
    }

    /* Registration form styles */
    .registration-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .registration-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      padding: 48px 36px 36px 36px;
      max-width: 440px;
      width: 100%;
      border: 1.5px solid #e0e0e0;
    }

    .event-logo {
      max-width: 110px;
      margin: 0 auto 18px auto;
      display: block;
    }

    .event-title {
      font-size: 1.45rem;
      font-weight: 700;
      margin-bottom: 18px;
      text-align: center;
      color: #222;
    }

    .event-header {
      font-size: 1.1rem;
      font-weight: 500;
      text-align: center;
      margin-bottom: 18px;
      color: #333;
    }

    .registration-form label {
      font-weight: 500;
      margin-bottom: 4px;
      color: #222;
      display: block;
    }

    .registration-form input,
    .registration-form select {
      width: 100%;
      padding: 13px 14px;
      border: 1.5px solid #cfd8dc;
      border-radius: 7px;
      margin-bottom: 20px;
      font-size: 1.07rem;
      background: #f7fafd;
    }

    .registration-form input:focus,
    .registration-form select:focus {
      border: 1.5px solid #0a1931;
      outline: none;
    }

    .registration-form input[type="submit"] {
      background: #0a1931;
      color: #fff;
      border: none;
      border-radius: 7px;
      font-size: 1.13rem;
      font-weight: 700;
      padding: 14px 0;
      cursor: pointer;
    }

    .registration-form input[type="submit"]:hover {
      background: #1a2951;
    }

    .form-note {
      font-size: 0.97em;
      color: #888;
      margin-bottom: 12px;
      text-align: left;
    }

    @media (max-width: 600px) {
      .registration-card {
        padding: 24px 8px 18px 8px;
        max-width: 98vw;
      }
    }
  </style>
</head>
<body>

<div class="toolbar">
  <select id="dropdown">
    <option value="">Select Option</option>
    <option value="header">Add Header</option>
    <option value="footer">Add Footer</option>
    <option value="both">Add Both</option>
    <option value="removeHeader">Remove Header</option>
    <option value="removeFooter">Remove Footer</option>
  </select>

  <input type="file" accept="image/*" id="uploadImg" title="Upload Background Image">

  <button id="addLogoBtn">Add Logo in Header</button>

  <input type="file" accept="image/*" id="headerLogoUpload" title="Upload Header Logo">

  <select id="logoAlignment">
    <option value="">Logo Align</option>
    <option value="flex-start">Left</option>
    <option value="center">Center</option>
    <option value="flex-end">Right</option>
  </select>

  <button id="saveDesign" style="background: #28a745; color: white; font-weight: bold;">ðŸ’¾ Save Design</button>
</div>

<div class="page-wrapper" id="pageWrapper">
  <div class="canvas-container" id="canvas">
    <div class="canvas-content" contenteditable="false">
      <div class="registration-container">
        <div class="registration-card">
          <img src="https://via.placeholder.com/110x60?text=Logo" class="event-logo" alt="Event Logo">
          <div class="event-title" contenteditable="true">Sample Event Name</div>
          <div class="event-header" contenteditable="true">Welcome to Our Event Registration</div>

          <form class="registration-form" action="/event/{{eventId}}/public-register" method="POST">
            <div class="reorder-instructions">
              âœ¨ Reorder Mode Active! Drag any field up or down to rearrange the form layout.
            </div>

            {{#each fields}}
            <div class="form-field" data-field-name="{{this.fieldName}}" data-field-order="{{@index}}">
              <div class="field-order-indicator">{{add @index 1}}</div>
              {{formField this.fieldName this.fieldLabel this.fieldType this.fieldValue this.fieldMandatory ../badgeCategories this.dropdownOptions}}
            </div>
            {{/each}}

            <div class="form-note" contenteditable="true">Please provide the correct email address you would like to receive your confirmation email.</div>
            <input type="submit" value="REGISTER">
          </form>

          <div class="event-footer" contenteditable="true">Thank you for registering!</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const dropdown = document.getElementById("dropdown");
  const pageWrapper = document.getElementById("pageWrapper");
  const canvas = document.getElementById("canvas");
  const uploadImg = document.getElementById("uploadImg");
  const addLogoBtn = document.getElementById("addLogoBtn");
  const headerLogoUpload = document.getElementById("headerLogoUpload");
  const logoAlignment = document.getElementById("logoAlignment");

  dropdown.addEventListener("change", () => {
    const value = dropdown.value;
    if (value === "header") addHeader();
    else if (value === "footer") addFooter();
    else if (value === "both") { addHeader(); addFooter(); }
    else if (value === "removeHeader") removeHeader();
    else if (value === "removeFooter") removeFooter();
    dropdown.value = "";
  });

  function addHeader() {
    if (!document.querySelector("header")) {
      const header = document.createElement("header");
      pageWrapper.insertBefore(header, canvas);
    }
  }

  function addFooter() {
    if (!document.querySelector("footer")) {
      const footer = document.createElement("footer");
      footer.setAttribute("contenteditable", "true");
      footer.innerText = "Footer Text - Edit me";
      pageWrapper.appendChild(footer);
    }
  }

  function removeHeader() { const header = document.querySelector("header"); if(header) header.remove(); }
  function removeFooter() { const footer = document.querySelector("footer"); if(footer) footer.remove(); }

  // Background image for canvas only
  uploadImg.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = (event) => canvas.style.backgroundImage = `url(${event.target.result})`;
      reader.readAsDataURL(file);
    }
  });

  // Add logo button
  addLogoBtn.addEventListener("click", () => {
    addHeader();
    const header = document.querySelector("header");
    if(header && !header.querySelector("img")){
      const logo = document.createElement("img");
      logo.src = "https://via.placeholder.com/300x80?text=Logo";
      header.appendChild(logo);
    }
  });

  // Header logo upload
  headerLogoUpload.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = (event) => {
        addHeader();
        const header = document.querySelector("header");
        if(header){
          let img = header.querySelector("img");
          if(!img){
            img = document.createElement("img");
            header.appendChild(img);
          }
          img.src = event.target.result;
        }
      };
      reader.readAsDataURL(file);
    }
  });

  // Logo alignment
  logoAlignment.addEventListener("change", () => {
    const header = document.querySelector("header");
    if(header) header.style.justifyContent = logoAlignment.value || "center";
  });

  // Save Design functionality
  const saveDesign = document.getElementById("saveDesign");
  saveDesign.addEventListener("click", () => {
    const header = document.querySelector("header");
    const footer = document.querySelector("footer");
    const canvasHtml = pageWrapper.innerHTML;
    
    // Create FormData for sending files and data
    const formData = new FormData();
    formData.append('pageType', 'registration');
    formData.append('canvasHtml', canvasHtml);
    
    // Header data
    // Set headerExists true if header exists in DOM
    formData.append('headerExists', header ? true : false);
    if(header) {
      const headerLogo = header.querySelector('img');
      formData.append('logoAlignment', header.style.justifyContent || 'center');
      // Always send logo if <img> exists, regardless of src format
      if(headerLogo && headerLogo.src) {
        formData.append('logoUrl', headerLogo.src);
      } else {
        formData.append('logoUrl', '');
      }
    } else {
      formData.append('logoUrl', '');
    }
    
    // Footer data
    formData.append('footerExists', !!footer);
    if(footer) {
      formData.append('footerContent', footer.innerText);
    }
    
    // Background image
    const backgroundImage = canvas.style.backgroundImage;
    if(backgroundImage && backgroundImage !== 'none') {
      // Try to extract the URL from backgroundImage style
      const urlMatch = backgroundImage.match(/url\(["']?([^"')]+)["']?\)/);
      if(urlMatch && urlMatch[1]) {
        formData.append('backgroundImage', urlMatch[1]);
      } else {
        formData.append('backgroundImage', '');
      }
    } else {
      formData.append('backgroundImage', '');
    }
    
    // Get editable content
    const eventTitle = document.querySelector('.event-title');
    const eventHeader = document.querySelector('.event-header');
    const eventFooterContent = document.querySelector('.event-footer');
    
    if(eventTitle) formData.append('eventTitle', eventTitle.innerText);
    if(eventHeader) formData.append('eventHeader', eventHeader.innerText);
    if(eventFooterContent) formData.append('eventFooter', eventFooterContent.innerText);
    
    // Show saving state
    saveDesign.innerText = 'ðŸ’¾ Saving...';
    saveDesign.disabled = true;
    
    // Send to server
    fetch('/event/online-registration/{{eventId}}/save-design', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if(data.success) {
        alert('âœ… Design saved successfully!\n\nYour public registration link:\n' + window.location.origin + '/event/public-registration/{{eventId}}');
      } else {
        alert('âŒ Error saving design: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Save error:', error);
      alert('âŒ Error saving design. Please try again.');
    })
    .finally(() => {
      saveDesign.innerText = 'ðŸ’¾ Save Design';
      saveDesign.disabled = false;
    });
  });
</script>

</body>
</html>
