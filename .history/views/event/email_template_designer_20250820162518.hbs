<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Email Template Designer - {{event.eventName}}</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      height: 100vh;
    }

    .designer-container {
      display: flex;
      width: 100%;
      height: 100%;
    }

    .sidebar {
      width: 300px;
      background: #fff;
      border-right: 1px solid #ddd;
      padding: 20px;
      overflow-y: auto;
    }

    .preview-container {
      flex: 1;
      padding: 20px;
      background: #f9f9f9;
      overflow-y: auto;
    }

    .email-preview {
      max-width: 600px;
      margin: 0 auto;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .preview-header {
      background: #f8f9fa;
      padding: 15px 20px;
      border-bottom: 1px solid #e9ecef;
      color: #6c757d;
      font-size: 14px;
    }

    .email-content {
      padding: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .color-input {
      width: 100% !important;
      height: 40px;
      padding: 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      margin: 5px;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .actions {
      padding: 20px;
      border-top: 1px solid #eee;
      background: #f8f9fa;
    }

    .variable-list {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
    }

    .variable-item {
      display: block;
      background: #e9ecef;
      padding: 5px 8px;
      margin: 3px 0;
      border-radius: 3px;
      font-family: monospace;
      font-size: 12px;
      cursor: pointer;
    }

    .variable-item:hover {
      background: #dee2e6;
    }

    h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }

    .template-preview {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 20px;
      margin-top: 20px;
    }

    .help-text {
      font-size: 12px;
      color: #6c757d;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<div class="designer-container">
  <!-- Sidebar with email template controls -->
  <div class="sidebar">
    <h3>üìß Email Template Designer</h3>
    
    <form id="emailTemplateForm">
      <div class="form-group">
        <label for="emailSubject">Email Subject:</label>
        <input type="text" id="emailSubject" name="emailSubject" 
               value="Registration Confirmation - {{event.eventName}}"
               placeholder="Registration Confirmation - Event Name">
      </div>

      <div class="form-group">
        <label for="emailHeader">Header Title:</label>
        <input type="text" id="emailHeader" name="emailHeader" 
               value="Registration Confirmed!"
               placeholder="Registration Confirmed!">
      </div>

      <div class="form-group">
        <label for="emailGreeting">Greeting Message:</label>
        <textarea id="emailGreeting" name="emailGreeting" 
                  placeholder="Dear {{fullName}}, Thank you for registering...">Dear {{fullName}},

Thank you for registering for {{eventName}}. Your registration has been successfully submitted.</textarea>
      </div>

      <div class="form-group">
        <label for="emailFooter">Footer Message:</label>
        <textarea id="emailFooter" name="emailFooter" 
                  placeholder="We look forward to seeing you...">Please keep this email for your records. We look forward to seeing you at the event!

If you have any questions, please contact our support team.</textarea>
      </div>

      <div class="form-group">
        <label for="primaryColor">Primary Color:</label>
        <input type="color" id="primaryColor" name="primaryColor" 
               value="#007bff" class="color-input">
      </div>

      <div class="form-group">
        <label for="backgroundColor">Background Color:</label>
        <input type="color" id="backgroundColor" name="backgroundColor" 
               value="#f8f9fa" class="color-input">
      </div>

      <div class="form-group">
        <label>Available Variables:</label>
        <div class="help-text">Click to insert into content</div>
        <div class="variable-list">
          <span class="variable-item" onclick="insertVariable('{{fullName}}')">{{fullName}}</span>
          <span class="variable-item" onclick="insertVariable('{{firstName}}')">{{firstName}}</span>
          <span class="variable-item" onclick="insertVariable('{{lastName}}')">{{lastName}}</span>
          <span class="variable-item" onclick="insertVariable('{{email}}')">{{email}}</span>
          <span class="variable-item" onclick="insertVariable('{{eventName}}')">{{eventName}}</span>
          <span class="variable-item" onclick="insertVariable('{{registrationId}}')">{{registrationId}}</span>
          <span class="variable-item" onclick="insertVariable('{{companyName}}')">{{companyName}}</span>
          <span class="variable-item" onclick="insertVariable('{{badgeCategory}}')">{{badgeCategory}}</span>
          <span class="variable-item" onclick="insertVariable('{{registrationDate}}')">{{registrationDate}}</span>
          <span class="variable-item" onclick="insertVariable('{{confirmationUrl}}')">{{confirmationUrl}}</span>
        </div>
      </div>
    </form>

    <div class="actions">
      <button type="button" class="btn btn-success" onclick="saveEmailTemplate()">
        üíæ Save Email Template
      </button>
      <button type="button" class="btn btn-primary" onclick="sendTestEmail()">
        üìß Send Test Email
      </button>
      <a href="/event/online-registration/{{eventId}}" class="btn btn-secondary">
        ‚Üê Back to Manager
      </a>
    </div>
  </div>

  <!-- Email Preview -->
  <div class="preview-container">
    <div class="email-preview">
      <div class="preview-header">
        <strong>To:</strong> example@email.com<br>
        <strong>Subject:</strong> <span id="subjectPreview">Registration Confirmation - {{event.eventName}}</span>
      </div>
      <div class="email-content" id="emailPreviewContent">
        <!-- Email content will be generated here -->
      </div>
    </div>

    <div class="template-preview">
      <h4>üìã HTML Template Preview</h4>
      <textarea id="htmlTemplate" readonly style="width: 100%; height: 200px; font-family: monospace; font-size: 12px;"></textarea>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load existing email template if available
    loadEmailTemplate();
    
    // Update preview when form changes
    document.getElementById('emailTemplateForm').addEventListener('input', updatePreview);
    document.getElementById('emailTemplateForm').addEventListener('change', updatePreview);
    
    // Initial preview update
    updatePreview();
});

function updatePreview() {
    const subject = document.getElementById('emailSubject').value;
    const header = document.getElementById('emailHeader').value;
    const greeting = document.getElementById('emailGreeting').value;
    const footer = document.getElementById('emailFooter').value;
    const primaryColor = document.getElementById('primaryColor').value;
    const backgroundColor = document.getElementById('backgroundColor').value;
    
    // Update subject preview
    document.getElementById('subjectPreview').textContent = subject;
    
    // Generate email HTML
    const emailHTML = generateEmailHTML(header, greeting, footer, primaryColor, backgroundColor);
    
    // Update preview
    document.getElementById('emailPreviewContent').innerHTML = emailHTML;
    
    // Update HTML template display
    document.getElementById('htmlTemplate').value = emailHTML;
}

function generateEmailHTML(header, greeting, footer, primaryColor, backgroundColor) {
    return `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: ${backgroundColor};">
        <div style="text-align: center; padding: 20px 0;">
            <h1 style="color: ${primaryColor}; margin: 0; font-size: 28px;">${header}</h1>
        </div>
        
        <div style="background: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <div style="color: #333; line-height: 1.6; font-size: 16px;">
                ${greeting.replace(/\n/g, '<br>')}
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3 style="color: #333; margin-top: 0;">Registration Details:</h3>
                <p><strong>Registration ID:</strong> REG-{{registrationId}}</p>
                <p><strong>Event:</strong> {{eventName}}</p>
                <p><strong>Name:</strong> {{fullName}}</p>
                <p><strong>Email:</strong> {{email}}</p>
                <p><strong>Company:</strong> {{companyName}}</p>
                <p><strong>Badge Type:</strong> {{badgeCategory}}</p>
                <p><strong>Registration Date:</strong> {{registrationDate}}</p>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <a href="{{confirmationUrl}}" style="background: ${primaryColor}; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block; font-weight: bold;">
                    View Confirmation Page
                </a>
            </div>
            
            <div style="color: #333; line-height: 1.6; font-size: 16px;">
                ${footer.replace(/\n/g, '<br>')}
            </div>
        </div>
        
        <div style="text-align: center; padding: 20px 0;">
            <hr style="border: none; border-top: 1px solid #eee; margin: 30px 0;">
            <p style="font-size: 12px; color: #666;">
                This is an automated message. Please do not reply to this email.
            </p>
        </div>
    </div>`;
}

function insertVariable(variable) {
    const activeElement = document.activeElement;
    if (activeElement && (activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'INPUT')) {
        const start = activeElement.selectionStart;
        const end = activeElement.selectionEnd;
        const value = activeElement.value;
        activeElement.value = value.substring(0, start) + variable + value.substring(end);
        activeElement.focus();
        activeElement.setSelectionRange(start + variable.length, start + variable.length);
        updatePreview();
    }
}

function saveEmailTemplate() {
    const templateData = {
        emailSubject: document.getElementById('emailSubject').value,
        emailHeader: document.getElementById('emailHeader').value,
        emailGreeting: document.getElementById('emailGreeting').value,
        emailFooter: document.getElementById('emailFooter').value,
        primaryColor: document.getElementById('primaryColor').value,
        backgroundColor: document.getElementById('backgroundColor').value,
        htmlTemplate: document.getElementById('htmlTemplate').value
    };
    
    fetch('/event/online-registration/{{eventId}}/save-email-template', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(templateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Email template saved successfully!');
        } else {
            alert('‚ùå Error saving email template: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error saving email template');
    });
}

function sendTestEmail() {
    const email = prompt('Enter email address to send test to:');
    if (email && email.includes('@')) {
        fetch('/event/online-registration/{{eventId}}/send-test-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ testEmail: email })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Test email sent successfully to ' + email);
            } else {
                alert('‚ùå Error sending test email: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error sending test email');
        });
    }
}

function loadEmailTemplate() {
    fetch('/event/online-registration/{{eventId}}/get-email-template')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.template) {
            const template = data.template;
            document.getElementById('emailSubject').value = template.emailSubject || '';
            document.getElementById('emailHeader').value = template.emailHeader || '';
            document.getElementById('emailGreeting').value = template.emailGreeting || '';
            document.getElementById('emailFooter').value = template.emailFooter || '';
            document.getElementById('primaryColor').value = template.primaryColor || '#007bff';
            document.getElementById('backgroundColor').value = template.backgroundColor || '#f8f9fa';
            updatePreview();
        }
    })
    .catch(error => {
        console.error('Error loading template:', error);
    });
}
</script>

</body>
</html>
